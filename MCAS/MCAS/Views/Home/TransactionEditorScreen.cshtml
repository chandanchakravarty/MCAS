@model MCAS.Web.Objects.MastersHelper.TransactionModel
@using MCAS.Web.Objects.Resources.ClaimProcessing;
@using MCAS.Web.Objects.CommonHelper
@{
    
    ViewBag.Title = "TransactionEditor";
    Layout = "~/Views/Shared/_Layout.cshtml";
    var imagePath = Url.Content("~/Images/ajax-loader.gif");
}
<link href="@Url.Content("~/Content/jquery-ui.css")" rel="Stylesheet" media="screen" />
<link href="@Url.Content("~/Content/themes/base/jquery.ui.all.css")" rel="stylesheet" type="text/css" />
<link href='@Url.Content("~/Content/jquery.dataTables.min.css")' rel="stylesheet" type="text/css" />
<style type="text/css">
    #TransactionEditor > div > div:nth-child(1) > div > table tr:hover
    {
        cursor: pointer;
    }
    
    #ajaxSpinnerContainer
    {
        height: 11px;
    }
    #ajaxSpinnerImage
    {
        display: none;
    }
    
    .ajax-loader
    {
        position: absolute;
        left: 50%;
        top: 50%;
        margin-left: -32px;
        margin-top: -32px;
        display: block;
        z-index: 999999999999999;
    }
</style>
<script src="@Url.Content("~/Scripts/jquery-2.1.0.min.js")" type="text/javascript"></script>
<script src="@Url.Content("~/Scripts/jquery.validate.js")" type="text/javascript"></script>
<script src="@Url.Content("~/Scripts/jquery.validate.unobtrusive.min.js")" type="text/javascript"></script>
<script src="@Url.Content("~/Scripts/globalize/globalize.js")" type="text/javascript"></script>
<script src="@Url.Content("~/Scripts/globalize/cultures/globalize.culture.en-GB.js")" type="text/javascript"></script>
<script src="@Url.Content("~/Scripts/jquery-ui-v1.10.3.js")" type="text/javascript"></script>
<script src='@Url.Content("~/Scripts/jquery.dataTables.min.js")' type="text/javascript"></script>
<script src='@Url.Content("~/Scripts/fnReloadAjax.js")' type="text/javascript"></script>
<div class="dashboard-wrapper">
    <div class="container" id="reg3">
        <div class="row page-title" id="reg">
            <div class="col-lg-12" id="reg2" style="background-color: white;">
                <h2>
                    Home
                </h2>
                <ul class="breadcrumb">
                    <li>Transaction Editor Screen</li>
                </ul>
            </div>
        </div>
        <hr />
        <div id="testdiv">
        </div>
        <div class="row">
            <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
                <div class="panel panel-secondary">
                    <div class="panel-heading">
                        <h3 class="panel-title">
                            <i class="icon-keyboard"></i>Transaction Editor Screen</h3>
                        <div id="expanddiv" class="SearchCriteriaClose">
                        </div>
                    </div>
                    <div class="panel-body" id="searchdiv" style="display: none" data-ng-app="Loginapp" data-ng-controller="LoginAuditControl">
                        <div class="row">
                            <div class="col-lg-12">
                                <div class="col-lg-6">
                                    <div class="form-group">
                                        <label class="col-sm-4 control-label">
                                            Search Menu</label>
                                        <div class="col-sm-8">
                                            @Html.DropDownListFor(m => m.Selectcriteria, new SelectList(Model.SelectcriteriaList, "Value", "Text", "All"), new { @class = "form-control" })
                                        </div>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <div class="col-lg-6">
                                        @Html.DropDownListFor(m => m.Valuecriteria, new SelectList(Model.ValueList, "Value", "Text", ""), new { @class = "form-control" })
                                        @Html.TextBoxFor(m => m.Description, new { @class = "form-control", @maxlength = 100, style = "display: none;" })
                                        @Html.TextBoxFor(m => m.TimeStampString, new { @class = "form-control", @maxlength = 10, style = "display: none;" })
                                        @Html.TextBoxFor(m => m.UserName, new { @class = "form-control", @maxlength = 15, style = "display: none;" })
                                    </div>
                                </div>
                            </div>
                             <div class="col-lg-12">
                                <br />
                            </div>
                            <div class="col-lg-12 text-center">
                                <input id="btnSearch" class="btn btn-info" type="button" value="Search" />
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="container">
        <div class="row" id="toprow">
            <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12" id="TranDiv">
                <div class="panel panel-info">
                    <div class="container">
                        <div class="col-lg-12">
                        </div>
                        <h5 class="text-info">
                            Transaction History
                        </h5>
                        <hr />
                        <div class="panel-body">
                            <div class="col-lg-12">
                                <div class="table-responsive">
                                    <div id="ajaxSpinnerContainer">
                                        <img alt="" src="@imagePath" id="ajaxSpinnerImage" class="ajax-loader" />
                                    </div>
                                    <table id="TranTable" class="table table-striped table-hover" border="0" cellpadding="0"
                                        cellspacing="0">
                                        <thead>
                                            <tr style="text-align: left; font-weight: bold; text-transform: capitalize; background-color: #C6C6C6;">
                                                <td style="width: 15%; word-break: break-all;">
                                                    Transaction ID
                                                </td>
                                                <td style="width: 20%; word-break: break-all;">
                                                    Screen Name
                                                </td>
                                                <td style="width: 20%; word-break: break-all;">
                                                    User Name
                                                </td>
                                                <td style="width: 30%; word-break: break-all;">
                                                    Transaction Description
                                                </td>
                                                <td style="width: 10%; word-break: break-all;">
                                                    TimeStamp
                                                </td>
                                            </tr>
                                        </thead>
                                        <tbody>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            <div>
                                <br />
                            </div>
                            <div id="TransactionDetails" style="display: none;">
                                <h5 class="text-info">
                                    Transaction Details
                                </h5>
                            </div>
                            <div class="col-lg-12">
                                <div class="table-responsive">
                                    <table id="Result" class="table table-striped table-hover" style="display: none;"
                                        border="0" cellpadding="0" cellspacing="0">
                                        <thead>
                                            <tr style="text-align: left; text-transform: capitalize; background-color: #C6C6C6;">
                                                <td style="width: 32%; word-break: break-all; font-weight: bold">
                                                    Label Name
                                                </td>
                                                <td style="width: 34%; word-break: break-all; font-weight: bold">
                                                    Modified from
                                                </td>
                                                <td style="width: 34%; word-break: break-all; font-weight: bold">
                                                    Modified To
                                                </td>
                                            </tr>
                                        </thead>
                                        <tbody>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script type="text/javascript">
    var table = "";
    var bool = false;
    var do_on_load = function () {
        $('#TimeStampString').datepicker({
            dateFormat: "dd/mm/yy",
            showStatus: true,
            showWeeks: true,
            currentText: 'Now',
            autoSize: true,
            gotoCurrent: true,
            showAnim: 'blind',
            highlightWeek: true,
            changeMonth: !0,
            changeYear: !0,
            yearRange: "1951:2050"
        });
        $.ajaxSetup({ cache: false });
        $("#Selectcriteria").change(function () {
            $("#Result").find("tr:gt(0)").remove();
            $("#Result,#TransactionDetails").hide();
            "UserName" == $("#Selectcriteria").val() ? ($("#UserName").show(), $("#Valuecriteria,#TimeStampString,#Description").hide(), $("#UserName").val("")) : "TimeStamp" == $("#Selectcriteria").val() ? ($("#TimeStampString").show(), $("#Valuecriteria,#UserName,#Description").hide(), $("#TimeStampString").val("")) : "Description" == $("#Selectcriteria").val() ? ($("#Description").show(), $("#Valuecriteria,#UserName,#TimeStampString").hide(), $("#Description").val("")) : ($("#Valuecriteria").show(), $("#TimeStampString,#UserName,#Description").hide(), $("#Valuecriteria").prop("selectedIndex", 0));
            $.ajax({
                type: "POST",
                url: '@Url.Action("GetvalueList", "Home")',
                data: {
                    cat: $("#Selectcriteria").val(),
                    UniqueId: guid()
                },
                success: function (a) {
                    $("#Valuecriteria").empty();
                    $.each(a, function (index, item) {
                        $("#Valuecriteria").append("<option value='" + item.Value + "'>" + item.Text + "</option>");
                    });
                }
            });
        });


        $("#btnSearch").click(function () {
            bool = false;
            table.fnFilter('');
            bool = true;
            $("#Result").find("tr:gt(0)").remove();
            $("#Result,#TransactionDetails").hide();
            table.api().ajax.reload();
        });

        table = $('#TranTable').dataTable({
            "bProcessing": true,
            "serverSide": true,
            "cache": false,
            "oLanguage": {
                "sSearch": '@MCAS.Web.Objects.Resources.Common.Common.Search',
                "sInfo": "@MCAS.Web.Objects.Resources.Common.Common.Showing _START_ @MCAS.Web.Objects.Resources.Common.Common.to _END_ @MCAS.Web.Objects.Resources.Common.Common.of _TOTAL_ @MCAS.Web.Objects.Resources.Common.Common.entries",
                "sLengthMenu": "@MCAS.Web.Objects.Resources.Common.Common.Show  _MENU_ @MCAS.Web.Objects.Resources.Common.Common.entries",
                "sEmptyTable": "@MCAS.Web.Objects.Resources.Common.Common.sEmptyTable",
                "sInfoEmpty": "@MCAS.Web.Objects.Resources.Common.Common.sInfoEmpty",
                "sProcessing": "<img src='@imagePath' />",
                "oPaginate": {
                    "sNext": '@MCAS.Web.Objects.Resources.Common.Common.Next',
                    "sLast": '@MCAS.Web.Objects.Resources.Common.Common.Last',
                    "sFirst": '@MCAS.Web.Objects.Resources.Common.Common.First',
                    "sPrevious": '@MCAS.Web.Objects.Resources.Common.Common.Previous'
                }
            },
            "bDestroy": true,
            "lengthMenu": [[10, 20, 50, -1], [10, 20, 50, "All"]],
            "ajax": {
                "url": '@Url.Action("TransactionEditorScreenJson", "Home")',
                "type": "POST",
                data: function (d) {
                    d.guid = guid(),
                    d.Selectcriteria = $("#Selectcriteria").val(),
                    d.Valuecriteria = $("#Valuecriteria").is(':visible') ? $("#Valuecriteria").val() : $("#UserName").is(':visible') ? $("#UserName").val() : $("#Description").is(':visible') ? $("#Description").val() : $("#TimeStampString").val(),
                    d.bool = bool
                }
               ,
                "cache": false
            },
            "aaSorting": [[0, 'desc']],
            "aoColumns": [
            { 'sWidth': '20%' },
            { 'sWidth': '20%' },
            { 'sWidth': '20%' },
            { 'sWidth': '20%' },
            { 'sWidth': '20%' }
    ],
            "fnRowCallback": function (nRow, aData, iDisplayIndex, iDisplayIndexFull) {
                $(nRow).addClass("TransTable");
                $(nRow).attr('id', aData[0]);
            },
            "fnDrawCallback": function (oSettings) {
                $('#Result').find("tr:gt(0)").remove();
                $('#Result,#TransactionDetails').hide();
            }

        });

        $("body").delegate("tr", "click", function () {
            var id = "#" + this.id;
            if ($(id).hasClass("TransTable")) {
                $("#ajaxSpinnerImage").show();
                $.ajax({
                    type: "POST",
                    url: '@Url.Action("GetTransactionHistoryDetails", "ClaimProcessing")',
                    data: { TranAuditId: this.id },
                    success: function (data) {
                        $('#Result').find("tr:gt(0)").remove();
                        for (var i = 0, j = 0; i < data.length; i++, j++) {
                            var a = data[i]['NodeName'], b = data[i]['OldData'] == null ? "" : data[i]['OldData'].toString(), c = data[i]['NewData'] == null ? "" : data[i]['NewData'].toString();
                            var e = data[i]['CmpCode']
                            var f = data[i]['CmpDetails']
                            if (e == 'CmpCode') {
                                $('#Result > tbody:last').append('<tr style="text-align: left; text-transform: capitalize;"> <td style="width:32%;word-break: break-all;text-transform: capitalize; background-color: #C6C6C6;font-weight:bold" colspan="3"> ' + f + ' </td></tr>');
                            }
                            if (a != "EntityKey") {
                                if (a == 'CreatedDate' || a == 'ModifiedDate' || a == 'ReAssignDateFrom' || a == 'ReAssignDateTo') {
                                    b = b == "" ? "" : b.replaceAt(10, ' ').substring(0, 19);
                                    c = c == "" ? "" : c.replaceAt(10, ' ').substring(0, 19);
                                    var d = j + 1;
                                    if (b != c && f == '') {
                                        $('#Result > tbody:last').append('<tr style="text-align: left; text-transform: capitalize;"> <td style="width:32%;word-break: break-all;"> ' + a + ' </td> <td style="width:34%;word-break: break-all;"> ' + b + ' </td> <td style="width:34%;word-break: break-all;"> ' + c + '</td></tr>');
                                    }
                                }
                                else {
                                    var d = j + 1;
                                    if (b != c && f == '') {
                                        $('#Result > tbody:last').append('<tr style="text-align: left; text-transform: capitalize;"> <td style="width:32%;word-break: break-all;"> ' + a + ' </td> <td style="width:34%;word-break: break-all;"> ' + b + ' </td> <td style="width:34%;word-break: break-all;"> ' + c + '</td></tr>');
                                    }
                                }
                            }
                            else {
                                j = j - 1;
                            }
                        }
                        $('#Result,#TransactionDetails').show();
                        $('#Result').addClass("table table-striped table-hover");
                        $("#ajaxSpinnerImage").hide();
                    },
                    error: function (data) {
                        if (data.readyState != 0) {
                            if (data.readyState == 4 && data.status == 200) {
                            }
                            else {
                                alert("error : " + data);
                            }
                        }
                        $('#Result,#TransactionDetails').hide();
                        $("#ajaxSpinnerImage").hide();
                    }
                });
            };
        })
    };

    $(document).ready(do_on_load);
    $(window).bind('page:change', do_on_load);

    var guid = (function () {
        function s4() {
            return Math.floor((1 + Math.random()) * 0x10000).toString(16).substring(1);
        }
        return function () {
            return s4() + s4() + '-' + s4() + '-' + s4() + '-' + s4() + '-' + s4() + s4() + s4();
        };
    })();
    String.prototype.replaceAt = function (index, character) {
        return this.substr(0, index) + character + this.substr(index + character.length);
    };
</script>
