@model IEnumerable<MCAS.Web.Objects.MastersHelper.TransactionModel>
@using MCAS.Web.Objects.Resources.ClaimProcessing;
@using MCAS.Web.Objects.Resources.Common;
@using MCAS.Web.Objects.CommonHelper
@using MCAS.Globalisation
@{
    var mMCASQueryString = Html.MCASQueryString(Request.QueryString);
    var caller = mMCASQueryString["claimMode"] == null ? "" : Convert.ToString(mMCASQueryString["claimMode"]);
    var pagemode = mMCASQueryString["mode"] == null ? "" : Convert.ToString(mMCASQueryString["mode"]);
    var accidentClaimIdNew = mMCASQueryString["AccidentClaimId"] == null ? "" : Convert.ToString(mMCASQueryString["AccidentClaimId"]);
    ViewBag.Title = "TransactionEditor";
    Layout = "~/Views/Shared/_Layout.cshtml";
    var policyid = mMCASQueryString["PolicyId"];
    var Hclaimant = mMCASQueryString["ClaimId"] == null ? "0" : mMCASQueryString["ClaimId"];
    var AccId = mMCASQueryString["AccidentClaimId"] == null ? "0" : mMCASQueryString["AccidentClaimId"];
    var Cmode = mMCASQueryString["claimMode"] == null ? "Read" : mMCASQueryString["claimMode"];
    var claimval = Cmode == "Write" ? "New Claim Registration" : "Incomplete Claim Registration";
    var SubMenu = !string.IsNullOrEmpty(Convert.ToString((HttpContext.Current.Session["ScreenNameDash"]))) ? MenuListItem.ClaimTabs.GetClaimLabel(Convert.ToString((HttpContext.Current.Session["ScreenNameDash"]))) : ClaimInfo.ResourceManager.GetString(MenuListItem.ClaimTabs.SubMenuString(@caller, @accidentClaimIdNew, @pagemode, "ClaimEditor"));
    SecurityPermissions myPemissions = (SecurityPermissions)ViewData["UserPermissions"];
}
@Html.Hidden("oldgroup", 1)
<style type="text/css">
    #TransactionEditor > div > div:nth-child(1) > div > table tr:hover
    {
        cursor: pointer;
    }
    
    #ajaxSpinnerContainer
    {
        height: 11px;
    }
    #ajaxSpinnerImage
    {
        display: none;
    }
   
    .ajax-loader
    {
        position: absolute;
        left: 50%;
        top: 50%;
        margin-left: -32px;
        margin-top: -32px;
        display: block;
        z-index: 999999999999999;
    }
</style>
<script src="@Url.Content("~/Scripts/jquery-2.1.0.min.js")" type="text/javascript"></script>
<div class="dashboard-wrapper">
    <div class="container">
        <div class="page-title" id="reg">
            <div class="col-lg-12" id="reg2" style="background-color: white; position: fixed;
                z-index: 1;">
                <h2>@ClaimInfo.ResourceManager.GetString(MenuListItem.ClaimTabs.PreBreadCrumbString(@pagemode))</h2>
                <ul class="breadcrumb">
                    <li>@SubMenu</li>
                    <li>@*Claims*@
                       @* @ClaimAccident.ResourceManager.GetString(MenuListItem.ClaimTabs.BreadCrumbString(@caller, @accidentClaimIdNew, @pagemode, "Claims"))*@
                       @TransactionEditor.TransactionsHistory
                    </li>
                </ul>
            </div>
            <div style="position: relative!important">
            @Html.Action("_ClaimDetails", "ClaimProcessing", new { PolicyId = @policyid })
        </div>
        </div>
        <hr />
        
        <div class="row" id="toprow">
            <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
                <div class="panel panel-info">
                    <div class="container">
                        @*<div class="panel-body" id="NewReserveEditor">
                            @using (Html.BeginForm("TransactionEditor", "ClaimProcessing", new { PolicyId = @policyid, AccidentClaimId = @AccId, claimMode = @Cmode, ClaimId = @Hclaimant }, FormMethod.Post, new { role = "form", @class = "form-horizontal", id = "TransactionEditor", name = "TransactionEditor" }))
                            {*@
                                <h5 class="text-info">
                                     @TransactionEditor.TransactionsHistory
                                </h5>
                                <hr />
                                <div class="panel-body">
                                    <div class="col-lg-12">
                                        <div class="table-responsive">
                                            <div id="ajaxSpinnerContainer">
                                                <img alt="" src="../../Images/ajax-loader.gif" id="ajaxSpinnerImage" class="ajax-loader" />
                                            </div>
                                            @if (@myPemissions.Write)
                                            {
                                                <table class="table table-striped table-hover" border="0" cellpadding="0" cellspacing="0">
                                                    <thead>
                                                        <tr style="text-align: left; font-weight: bold; text-transform: capitalize; background-color: #C6C6C6;">
                                                            <td style="width:15%; word-break: break-all;">
                                                                @TransactionEditor.TransactionID
                                                            </td>
                                                            <td style="width: 20%; word-break: break-all;">
                                                                @TransactionEditor.ScreenName
                                                            </td>
                                                            <td style="width: 20%; word-break: break-all;">
                                                                @TransactionEditor.UserName
                                                            </td>
                                                            <td style="width: 30%; word-break: break-all;">
                                                                @TransactionEditor.TransactionDescription
                                                            </td>
                                                            <td style="width: 10%; word-break: break-all;">
                                                                @TransactionEditor.TimeStamp
                                                            </td>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        @{
                                                int trid = 1;
                                                int rowmatch = 0;
                                                int sno = 0;
                                                var display = "";
                                                foreach (var item in Model)
                                                {
                                                    rowmatch += 1;
                                                    sno += 1;
                                                    var timestamp = item.TimeStamp;
                                                            <tr group='@(trid)' class="TransTable" id='@item.TranAuditId' style="text-align:left;text-transform:capitalize;display:@display;">
                                                                <td style="width: 15%;">@Html.DisplayFor(modelItem => item.TranAuditId)
                                                                </td>
                                                                <td style="width: 20%; word-break: break-all;">@Html.DisplayFor(modelItem => item.TableName)
                                                                </td>
                                                                <td style="width: 20%; word-break: break-all;">@Html.DisplayFor(modelItem => item.UserName)
                                                                </td>
                                                                <td style="width: 30%; word-break: break-all;">@Html.DisplayFor(modelItem => item.TansDescription)
                                                                </td>
                                                                <td style="width: 15%; word-break: break-all;">@timestamp.ToString()
                                                                </td>
                                                            </tr>
                                                    if (rowmatch > 9)
                                                    {
                                                        rowmatch = 0;
                                                        trid += 1;
                                                        display = "none";
                                                    }
                                                }
                                                        }
                                                    </tbody>
                                                </table>
                                            }
                                        </div>
                                    </div>
                                    @{
                                            decimal count = (decimal)Model.Count() / 10;
                                            int totalcount = (int)Math.Ceiling(count);
                                        <div class="row">
                                            <div class="col-lg-1 text-center">
                                                <div class="form-group">
                                                    <a class="btn btn-info" id="Previous">@Common.Previous</a>
                                                </div>
                                            </div>
                                            <div class="col-lg-10 text-center">
                                                <ul class="pagination no-margin">
                                                    <li id="liprevious" onclick="Pagination('liprevious');"><a href="#">«</a> </li>
                                                    @for (int j = 0; j < totalcount; j++)
                                                    {
                                                        if (j == 0)
                                                        { 
                                                        <li id="li@(j + 1)" class="active" onclick="Pagination('li@(j + 1)');"><a href="#">@(j + 1)</a>
                                                        </li>
                                                        }
                                                        else
                                                        {
                                                            if (j > 4)
                                                            {
                                                        <li id="li@(j + 1)" style="display: none;" onclick="Pagination('li@(j + 1)');" ><a
                                                            href="#">@(j + 1)</a></li>
                                                            }
                                                            else
                                                            { 
                                                        <li id="li@(j + 1)" onclick="Pagination('li@(j + 1)');" ><a href="#">@(j + 1)</a></li>
                                                            }
                                                        }
                                                    }
                                                    <li id="linext" onclick="Pagination('linext');"><a href="#">»</a> </li>
                                                </ul>
                                            </div>
                                            <div class="col-lg-1 text-center">
                                                <div class="form-group">
                                                </div>
                                            </div>
                                        </div>
                                    }
                                    <div class="col-lg-12">
                                        <div class="table-responsive">
                                            <table id="Result" class="table table-striped table-hover" style="display: none;"
                                                border="0" cellpadding="0" cellspacing="0">
                                                <thead>
                                                    <tr style="text-align: left; text-transform: capitalize; background-color: #C6C6C6;">
                                                        <td style="width: 32%; word-break: break-all; font-weight:bold" >
                                                            @TransactionEditor.LabelName
                                                        </td>
                                                        <td style="width: 34%; word-break: break-all;font-weight:bold">
                                                            @TransactionEditor.Modifiedfrom
                                                        </td>
                                                        <td style="width: 34%; word-break: break-all;font-weight:bold">
                                                            @TransactionEditor.ModifiedTo
                                                        </td>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                           @* }
                        </div>*@
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script type="text/javascript">
    setTabActive('TransactionsHistoryTab');
    var do_on_load = function () {
        
        $('tr').click(function () {
            var id = "#" + this.id;
            if ($(id).hasClass("TransTable")) {
                $("#ajaxSpinnerImage").show();
                $.ajax({
                    type: "POST",
                    url: '@Url.ActionEncoded("GetTransactionHistoryDetails", "ClaimProcessing")',
                    data: { TranAuditId: this.id },
                    success: function (data) {
                        $('#Result').find("tr:gt(0)").remove();
                        for (var i = 0, j = 0; i < data.length; i++, j++) {
                            var a = data[i]['NodeName'], b = data[i]['OldData'] == null ? "" : data[i]['OldData'].toString(), c = data[i]['NewData'] == null ? "" : data[i]['NewData'].toString();
                            var e = data[i]['CmpCode']
                            var f = data[i]['CmpDetails']
                            if (e == 'CmpCode') {
                                $('#Result > tbody:last').append('<tr style="text-align: left; text-transform: capitalize;"> <td style="width:32%;word-break: break-all;text-transform: capitalize; background-color: #C6C6C6;font-weight:bold" colspan="3"> ' + f + ' </td></tr>');
                            }
                            if (a != "EntityKey") {
                                if (a == 'CreatedDate' || a == 'ModifiedDate' || a == 'ReAssignDateFrom' || a == 'ReAssignDateTo') {
                                    b = b == "" ? "" : b.replaceAt(10, ' ').substring(0, 19);
                                    c = c == "" ? "" : c.replaceAt(10, ' ').substring(0, 19);
                                    var d = j + 1;
                                    if (b != c && f == '') {
                                        $('#Result > tbody:last').append('<tr style="text-align: left; text-transform: capitalize;"> <td style="width:32%;word-break: break-all;"> ' + a + ' </td> <td style="width:34%;word-break: break-all;"> ' + b + ' </td> <td style="width:34%;word-break: break-all;"> ' + c + '</td></tr>');
                                    }
                                }
                                else {
                                    var d = j + 1;
                                    if (b != c && f == '') {
                                        $('#Result > tbody:last').append('<tr style="text-align: left; text-transform: capitalize;"> <td style="width:32%;word-break: break-all;"> ' + a + ' </td> <td style="width:34%;word-break: break-all;"> ' + b + ' </td> <td style="width:34%;word-break: break-all;"> ' + c + '</td></tr>');
                                    }
                                }
                            }
                            else {
                                j = j - 1;
                            }
                        }
                        $('#Result').show();
                        $('#Result').addClass("table table-striped table-hover");
                        $("#ajaxSpinnerImage").hide();
                    },
                    error: function (data) {
                        if (data.readyState != 0) {
                            if (data.readyState == 4 && data.status == 200) {
                            }
                            else {
                                alert("error : " + data);
                            }
                        }
                        $('#Result').hide();
                        $("#ajaxSpinnerImage").hide();
                    }
                });
            };
        });
        SetDivPost();
    };

    $(document).ready(do_on_load);
    $(window).bind('page:change', do_on_load);

    function Pagination(id) {
        $('#Result').hide();
        var totalcount = Math.ceil(parseFloat('@Model.Count()' / 10));
        if (id == "linext") {
            id = "li" + (parseInt($("#oldgroup").val()) == totalcount ? totalcount : (parseInt($("#oldgroup").val()) + 1));
        }
        if (id == "liprevious") {
            id = "li" + (parseInt($("#oldgroup").val()) == 1 ? 1 : (parseInt($("#oldgroup").val()) - 1));
        }
        var oldgroup_id = $("#oldgroup").val();
        var tabid_id = id.replace("li", "");
        $("#oldgroup").val(tabid_id);
        $("table tr[group=" + oldgroup_id + "]").css("display", "none");
        $("table tr[group=" + tabid_id + "]").css("display", "");
        $('.active').removeClass();
        $('#' + id).addClass("active");

        if (totalcount > 0) {
            for (i = 1; i <= totalcount; i++) {
                $("#li" + i).css("display", "none");
            }
            if (tabid_id > 1) {

                if (parseFloat(tabid_id) + 2 <= parseFloat(totalcount)) {
                    for (i = parseFloat(tabid_id == 2 ? 3 : tabid_id) - 2; i <= parseFloat(tabid_id == 2 ? 3 : tabid_id) + 2; i++) {
                        if (i <= totalcount) {
                            $("#li" + i).css("display", "");
                        }
                    }
                }
                else {
                    for (i = parseFloat(totalcount) - 4; i <= parseFloat(totalcount); i++) {

                        $("#li" + i).css("display", "");
                    }
                }
            }
            else {
                for (i = parseFloat(1); i <= parseFloat(5); i++) {
                    $("#li" + i).css("display", "");
                }
            };
        };
      setTabActive('TransactionsHistoryTab');
    };
    String.prototype.replaceAt = function (index, character) {
        return this.substr(0, index) + character + this.substr(index + character.length);
    };
</script>
